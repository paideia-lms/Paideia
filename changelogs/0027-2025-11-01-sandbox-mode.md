# Changelog 0027: Sandbox Mode for Development and Testing

**Date**: November 1, 2025  
**Type**: Feature Addition  
**Impact**: High - Enables automated database reset for development and testing environments with customizable seed data

## Overview

Implemented a comprehensive sandbox mode that automatically resets the database daily (and on server startup) with predefined test data or custom seed data from a `seed.json` file. The feature includes environment variable control, Zod schema validation for seed data, Payload cron job integration for daily resets, and a prominent warning alert displayed site-wide when sandbox mode is enabled. This feature is designed for testing and development environments where consistent data state is essential.

## Features Added

### 1. Sandbox Mode Environment Variable

**Features**:
- Environment variable `SANDBOX_MODE` to control sandbox mode activation
- Boolean parsing (accepts "1" or "true" to enable)
- Server admin controlled (only accessible via environment configuration)
- Default: disabled

**Implementation**:
- Added `SANDBOX_MODE` to `server/env.ts` with getter `enabled` property
- Non-sensitive environment variable
- Optional (not required)
- Defaults to "0" (disabled)

### 2. Zod Schema for Seed Data Validation

**Features**:
- Comprehensive Zod schema matching the test data structure
- Validates all seed data fields including:
  - Admin user credentials (email, password, firstName, lastName)
  - Users array (student, teacher, ta, additionalStudents)
  - Courses array (title, description, slug, status)
  - Modules (page, quiz, assignment, discussion, whiteboard types)
  - Sections array
  - Enrollment statuses array
- Type-safe seed data structure

**Implementation**:
- Created `server/utils/db/seed-schema.ts` with `seedDataSchema`
- Exported TypeScript type `SeedData` inferred from schema
- Supports all module types with proper validation
- Validates thread sorting enum values for discussions

### 3. Generic Seed Function with Custom Data Support

**Features**:
- Refactored `runSeed` to accept optional `seedData` parameter
- Falls back to predefined `testData` if no seed data provided
- Maintains backward compatibility with existing functionality
- Admin credentials now part of seed data structure

**Implementation**:
- Modified `RunSeedArgs` interface to accept optional `seedData: SeedData`
- Updated all references from `testData` to use provided `seedData` or fallback
- Moved admin email/password from `devConstants` into `testData.admin`
- Exported `testData` for use as fallback in other modules
- Function located in `server/utils/db/seed.ts`

### 4. Seed Data Loader with JSON File Support

**Features**:
- Loads `seed.json` from project root if exists
- Validates JSON against Zod schema
- Falls back to predefined `testData` if file doesn't exist or is invalid
- Logs warnings for validation failures
- Always returns valid seed data (never fails completely)

**Implementation**:
- Created `server/utils/load-seed-data.ts` with `tryLoadSeedData()` function
- Uses Node.js `fs` module to check file existence and read JSON
- Validates parsed JSON against `seedDataSchema`
- Returns `Result<SeedData>` with fallback to `testData`
- Uses `Result` pattern for error handling (no try/catch)

### 5. Sandbox Reset Utility Function

**Features**:
- Reusable function for resetting sandbox database
- Checks sandbox mode before executing
- Runs `migrateFresh` to drop and recreate database
- Loads seed data (with fallback)
- Seeds database with loaded data
- Comprehensive error handling using Result pattern

**Implementation**:
- Created `server/utils/db/sandbox-reset.ts` with `tryResetSandbox()` function
- Accepts `payload: Payload` parameter
- Returns early if sandbox mode not enabled
- Uses `migrateFresh` from `server/utils/db/migrate-fresh`
- Loads migrations from `src/migrations`
- Calls `tryLoadSeedData()` and `runSeed()` sequentially
- Returns `Result<void>` with success/error state

### 6. Payload Cron Job for Daily Reset

**Features**:
- Payload task that resets sandbox database daily at midnight
- Uses `'nightly'` queue already configured in Payload
- Conditional scheduling based on sandbox mode status
- Returns task execution status and messages

**Implementation**:
- Created `server/tasks/sandbox-reset.ts` with Payload task configuration
- Task slug: `'sandboxReset'`
- Schedule: Daily at midnight (`'0 0 * * *'`) using `'nightly'` queue
- `beforeSchedule` hook checks `SANDBOX_MODE.enabled` before scheduling
- Handler calls `tryResetSandbox()` and returns success/error state
- Added task to `jobs.tasks` array in `server/payload.config.ts`
- Uses `Result` pattern for error handling

### 7. Server Startup Reset

**Features**:
- Automatically resets database on server startup when sandbox mode enabled
- Runs before normal migration/seeding process
- Graceful error handling (doesn't crash server on failure)
- Logs appropriate messages for success/failure

**Implementation**:
- Updated `server/index.ts` `startServer()` function
- Checks `envVars.SANDBOX_MODE.enabled` after payload initialization
- Calls `tryResetSandbox(payload)` if enabled
- Logs warnings on failure but continues server startup
- Skips normal development seeding if sandbox mode is active

### 8. Site-Wide Sandbox Mode Warning Alert

**Features**:
- Yellow warning alert displayed at the top of all pages when sandbox mode enabled
- Prominent visual indicator with warning icon
- Clear messaging about sandbox mode implications:
  - Everyone who registers gets admin role
  - All users can freely change their system role
  - Data is temporary and resets every midnight
  - Intended for testing/development only

**Implementation**:
- Added warning alert to `app/layouts/root-layout.tsx`
- Alert appears after header tabs, before page content
- Uses Mantine `Alert` component with yellow color and light variant
- Includes `IconAlertTriangle` icon for visual emphasis
- Conditionally rendered based on `isSandboxMode` from loader
- Loader gets `envVars` from global context and checks `SANDBOX_MODE.enabled`

## Technical Implementation

### Environment Variable Structure

```typescript
SANDBOX_MODE: {
    required: false,
    sensitive: false,
    value: process.env.SANDBOX_MODE,
    default: "0",
    get enabled() {
        const val = this.value ?? this.default;
        return val === "1" || val === "true";
    },
}
```

### Seed Data Schema Structure

The Zod schema validates the following structure:
- `admin`: Object with email, password, firstName, lastName
- `users`: Object containing student, teacher, ta objects, and additionalStudents array
- `courses`: Array of course objects with title, description, slug, status
- `modules`: Object with page object and additional array of module objects
- `sections`: Array of section objects with title and description
- `enrollmentStatuses`: Array of status enum values

### Sandbox Reset Flow

1. Check if `SANDBOX_MODE.enabled` is true (early return if false)
2. Run `migrateFresh()` to drop database and recreate schema
3. Load seed data using `tryLoadSeedData()` (falls back to testData if needed)
4. Run `runSeed()` with loaded seed data
5. Return success or error result

### Daily Reset Cron Job

The Payload task runs daily at midnight:
- Schedule: `'0 0 * * *'` (every day at midnight)
- Queue: `'nightly'` (already configured)
- Conditional: Only schedules if `SANDBOX_MODE.enabled` is true
- Task handler: Calls `tryResetSandbox()` and reports status

### Seed Data Loading Priority

1. Check if `./seed.json` exists in project root
2. If exists, read and parse JSON
3. Validate against Zod schema
4. If valid, return parsed data
5. If invalid or missing, log warning and return `testData` as fallback
6. Always returns valid seed data

## Files Changed

### New Files

1. **`server/utils/db/seed-schema.ts`**
   - Zod schema for seed data validation
   - Exported `SeedData` TypeScript type

2. **`server/utils/db/load-seed-data.ts`**
   - Function to load and validate `seed.json` from project root
   - Fallback logic to predefined test data

3. **`server/utils/db/sandbox-reset.ts`**
   - Reusable sandbox reset utility function
   - Integrates `migrateFresh`, seed loading, and seeding

4. **`server/tasks/sandbox-reset.ts`**
   - Payload task configuration for daily reset cron job
   - Task handler and scheduling logic

### Modified Files

1. **`server/env.ts`**
   - Added `SANDBOX_MODE` environment variable with boolean getter

2. **`server/utils/db/seed.ts`**
   - Refactored `runSeed` to accept optional `seedData` parameter
   - Moved admin credentials into `testData.admin`
   - Exported `testData` for use as fallback
   - Updated all `testData` references to use dynamic `data` variable

3. **`server/payload.config.ts`**
   - Added `sandboxReset` task to `jobs.tasks` array
   - Imported `TaskConfig` type from Payload

4. **`server/index.ts`**
   - Added sandbox mode check in `startServer()` function
   - Calls `tryResetSandbox()` on startup when enabled
   - Skips normal seeding/migration when sandbox mode active

5. **`app/layouts/root-layout.tsx`**
   - Added warning alert for sandbox mode
   - Updated loader to get `envVars` and check `SANDBOX_MODE.enabled`
   - Alert displayed at top of all pages when enabled

6. **`server/utils/constants.ts`**
   - Removed admin email/password from `devConstants` (moved to testData)
   - Kept only `asciiLogo` export

## Usage

### Enabling Sandbox Mode

Set the `SANDBOX_MODE` environment variable to `"1"` or `"true"`:

```bash
export SANDBOX_MODE=1
# or
export SANDBOX_MODE=true
```

### Custom Seed Data

Create a `seed.json` file in the project root with the validated seed data structure. If the file is invalid or missing, the system falls back to predefined test data.

**Example `seed.json` structure**:
```json
{
  "admin": {
    "email": "admin@example.com",
    "password": "adminpassword123",
    "firstName": "Admin",
    "lastName": "User"
  },
  "users": {
    "student": {
      "email": "student@example.com",
      "password": "password123",
      "firstName": "Student",
      "lastName": "User"
    },
    ...
  },
  "courses": [...],
  "modules": {...},
  "sections": [...],
  "enrollmentStatuses": ["active", "inactive", "completed"]
}
```

### Reset Behavior

When sandbox mode is enabled:
- **On startup**: Database is reset automatically using `migrateFresh` and seeded
- **Daily at midnight**: Payload cron job resets database and reseeds
- **Warning alert**: Displayed on all pages warning users about sandbox mode implications

## Testing Notes

- Sandbox mode should only be enabled in development/testing environments
- The warning alert provides clear indication of sandbox mode status
- Custom seed data files can be validated against the Zod schema before use
- Database resets are automatic and non-interactive (no prompts required)

## Security Considerations

- Sandbox mode warning clearly states that:
  - All registrations receive admin role
  - Users can freely change system roles
  - Data is temporary and resets daily
- Warning alert displayed prominently on all pages
- Environment variable must be explicitly set by server administrator
- Not enabled by default


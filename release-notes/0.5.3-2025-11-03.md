# Release Notes - Paideia LMS v0.5.3

**Release Date:** November 3, 2025  
**Version:** 0.5.3  
**Type**: Feature Enhancement  
**Impact**: Low - Adds flexibility for CSRF configuration via environment variables and fixes server-side authentication  
**Changelog**: 0034

## Overview

Paideia LMS v0.5.3 is a patch release that adds configurable CSRF (Cross-Site Request Forgery) protection origins support via environment variables. This release allows administrators to configure trusted CSRF origins without code changes, making it easier to deploy in different environments. This release also improves the default CORS configuration to fix server-side authentication issues.

---

## Features Added

### üîê Configurable CSRF Origins

**Problem**: CSRF origins were hardcoded in the configuration, making it difficult to configure for different environments (development, staging, production) without modifying code.

**Solution**: Added `CSRF_ORIGINS` environment variable support with flexible configuration options.

**Features**:
- **Environment variable-based configuration**: Configure CSRF via `.env` file or environment variables
- **Multiple origins**: Specify comma-separated URLs/domains for multiple trusted origins
- **Backward compatible**: Defaults to localhost if not configured
- **Automatic merging**: Default localhost origins are always included and merged with user configuration
- **Automatic trimming**: URLs are automatically trimmed and filtered

**Configuration Examples**:

**Default (localhost only)**:
```env
# Leave CSRF_ORIGINS unset or empty
# Defaults to: http://localhost:3000, localhost
```

**Specific origins (comma-separated)**:
```env
CSRF_ORIGINS=https://your-frontend-app.com,https://your-other-frontend-app.com,localhost
```

**Production example**:
```env
CSRF_ORIGINS=https://paideialms.com,https://www.paideialms.com,https://admin.paideialms.com
```

**Security Note**: Unlike CORS, CSRF protection does **not** support wildcard (`*`) for security reasons. CSRF attacks require explicit trusted origins to prevent cross-site request forgery.

**Benefits**:
- ‚úÖ Flexible CSRF configuration without code changes
- ‚úÖ Environment-specific configuration support
- ‚úÖ Backward compatible (defaults to localhost)
- ‚úÖ Security-focused (explicit origins required)
- ‚úÖ Easy to configure via `.env` file or environment variables
- ‚úÖ Merges with default origins for development compatibility

---

## Bug Fixes

### Server-Side Authentication Fix

**Problem**: Server-side authentication was failing when requests included the frontend origin (`http://localhost:3000`), requiring workarounds like deleting the origin header.

**Root Cause**: Default CORS configuration only included the backend origin (`http://localhost:3001`), causing Payload CMS to reject authentication requests with the frontend origin.

**Solution**: Updated default CORS configuration to include both frontend and backend origins, ensuring server-side authentication works correctly.

**Benefits**:
- ‚úÖ Server-side authentication works without workarounds
- ‚úÖ No need to delete origin header
- ‚úÖ Better support for React Router SSR requests
- ‚úÖ Improved default CORS configuration

---

## Migration Guide

### CSRF Configuration

**No migration required.** The update is backward compatible. Existing installations will continue to work with default localhost CSRF configuration.

**To configure CSRF origins**:

1. **Add `CSRF_ORIGINS` to your `.env` file**:
   ```env
   CSRF_ORIGINS=https://your-frontend-app.com,https://your-other-frontend-app.com
   ```

2. **Or set it as an environment variable**:
   ```bash
   export CSRF_ORIGINS="https://example.com,https://admin.example.com"
   ```

3. **Restart the application** to apply changes

### CORS Configuration

**No migration needed.** The changes are automatic and backward compatible:

- ‚úÖ Default CORS now includes both frontend and backend origins
- ‚úÖ Server-side authentication works correctly
- ‚úÖ No need for origin header manipulation workarounds

---

## Breaking Changes

None. All changes are backward compatible.

---

## Dependencies

No new dependencies added.

---

## Testing

- ‚úÖ Default CSRF configuration works (localhost)
- ‚úÖ Comma-separated URLs are parsed correctly
- ‚úÖ Empty values default to localhost
- ‚úÖ Default origins are merged with user configuration
- ‚úÖ Server-side authentication works with default CORS configuration
- ‚úÖ No need for origin header manipulation workarounds
- ‚úÖ Backward compatible with existing installations

---

## Environment Variables

### New Optional Environment Variable

**`CSRF_ORIGINS`**:
- **Type**: String (comma-separated URLs/domains)
- **Required**: No
- **Default**: `http://localhost:3000, localhost`
- **Description**: CSRF trusted origins. Can be:
  - Unset/empty: Defaults to localhost
  - Comma-separated URLs/domains: Allows specific trusted origins (e.g., `https://example.com,https://admin.example.com`)
- **Security Note**: Wildcard (`*`) is **not** supported for CSRF for security reasons

**Example**:
```env
CSRF_ORIGINS=https://paideialms.com,https://www.paideialms.com,https://admin.paideialms.com
```

See `server/env.ts` for the complete list of environment variables.

---

## Security Considerations

### CSRF Protection

**Important**: Unlike CORS, CSRF protection does **not** support wildcard (`*`) for security reasons. CSRF attacks require explicit trusted origins to prevent cross-site request forgery.

**Best Practices**:
- Always specify explicit origins in production
- Use comma-separated URLs for multiple trusted domains
- Include both protocol and domain (e.g., `https://example.com`, not just `example.com`)
- Test thoroughly before deploying to production

### CORS vs CSRF

**CORS (Cross-Origin Resource Sharing)**:
- Controls which origins can make requests to your API
- Supports wildcard (`*`) for development
- Configured via `CORS_ORIGINS` environment variable

**CSRF (Cross-Site Request Forgery)**:
- Controls which origins can make authenticated requests with cookies
- Does **not** support wildcard (`*`) for security reasons
- Requires explicit trusted origins
- Configured via `CSRF_ORIGINS` environment variable

---

## Thank You

Thank you for using Paideia LMS. This patch release adds flexibility for CSRF configuration and fixes server-side authentication issues. We're committed to continuing to improve the platform based on your feedback.

For questions, issues, or contributions, please visit our GitHub repository: https://github.com/paideia-lms/paideia

---

## Complete Changelog Reference

This release includes all changes from changelog 0034:

### Configuration & Bug Fixes (0034)
- **0034** - Configurable CSRF Origins: Environment variable-based CSRF configuration with comma-separated URL support
- **0034** - Improved Default CORS Configuration: Fixed server-side authentication by including both frontend and backend origins

### Detailed Changelog

#### Configurable CSRF Origins
- Added `CSRF_ORIGINS` environment variable support
- Supports comma-separated URLs/domains for multiple trusted origins
- Backward compatible (defaults to localhost if not set)
- Automatic URL trimming and filtering
- Merges with default localhost origins for development compatibility
- Security-focused (explicit origins required, no wildcard support)

#### Improved Default CORS Configuration
- Updated default CORS configuration to include both frontend and backend origins
- Ensures server-side authentication works correctly with React Router SSR
- Removed the need for origin header manipulation workarounds
- Better support for server-side requests

---

**Full Changelog Details**: See changelog file `changelogs/0034-2025-11-03-configurable-csrf-origins.md` for detailed information about each feature and change.


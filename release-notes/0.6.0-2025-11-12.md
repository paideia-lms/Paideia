# Release Notes - Paideia LMS v0.6.0

**Release Date:** November 12, 2025  
**Version:** 0.6.0  
**Type**: Feature Addition / Enhancement  
**Impact**: High - Comprehensive media management system with user drive, admin controls, usage tracking, and site customization  
**Changelog**: 0040, 0041, 0042, 0043, 0044, 0045, 0046

## Overview

Paideia LMS v0.6.0 introduces a complete media management system that transforms how users and administrators handle files throughout the platform. This release adds a personal media drive for users, comprehensive admin media management tools, intelligent usage tracking to prevent accidental deletions, orphaned file cleanup, and site-wide appearance customization. The update also includes configurable upload limits and storage quotas, making the system more flexible and production-ready.

---

## Features Added

### üìÅ User Media Drive

**Problem**: Users had no centralized way to manage their uploaded media files, making it difficult to:
- View all their uploaded files in one place
- Track storage usage
- Organize and manage media files
- Reuse files across different content types

**Solution**: Implemented a comprehensive user media drive that serves as the foundation for all media uploads in the LMS.

**Features**:
- **Personal Media Library**: Each user has their own media drive accessible from the user menu
- **Multiple View Modes**: Switch between card view (visual thumbnails) and table view (detailed list)
- **File Management**: Upload, download, rename, and delete media files
- **Storage Tracking**: See your current storage usage and quota limits
- **Batch Operations**: Select and delete multiple files at once
- **File Preview**: Click any file to preview images, videos, audio, PDFs, and more
- **Search and Filter**: Find files quickly with search functionality
- **Pagination**: Navigate through large media collections efficiently

**Benefits**:
- ‚úÖ Centralized media management for users
- ‚úÖ Foundation for media uploads in assignments, notes, and other content
- ‚úÖ Clear visibility into storage usage
- ‚úÖ Easy file organization and reuse
- ‚úÖ Consistent user experience across the platform

### ‚öôÔ∏è Site Policies and Upload Limits

**Problem**: No way to control file upload sizes or user storage quotas, leading to:
- Potential storage abuse
- No limits on file sizes
- No visibility into storage usage
- Inconsistent upload behavior

**Solution**: Implemented configurable site-wide policies for upload limits and storage quotas.

**Features**:
- **Upload Size Limits**: Administrators can set maximum file size for all uploads (default: 20 MB)
- **Storage Quotas**: Configure per-user storage limits (default: 10 GB per user)
- **Unlimited Options**: Support for unlimited storage or upload sizes when set to null
- **Real-time Validation**: Upload limits are enforced at the point of upload
- **Storage Display**: Media drive shows actual configured quota instead of hardcoded values
- **Audio/Video Streaming**: Efficient streaming support with HTTP Range requests for progressive loading
- **Inline Previews**: Preview audio and video files directly in the card view
- **Full-Size Previews**: Access full-size previews via modal for all media types including PDFs

**Administration**:
- Configure via Admin ‚Üí Server ‚Üí Site Policies
- Set upload limits and storage quotas per user
- View system-wide storage statistics
- Monitor storage usage across all users

**Benefits**:
- ‚úÖ Prevents storage abuse
- ‚úÖ Configurable limits for different deployment scenarios
- ‚úÖ Better user experience with streaming media
- ‚úÖ Efficient bandwidth usage with progressive loading

### ‚úèÔ∏è Media Rename Functionality

**Problem**: Users couldn't rename their media files after upload, making it difficult to:
- Organize files with meaningful names
- Fix typos in filenames
- Maintain consistent naming conventions

**Solution**: Added comprehensive rename functionality that updates both S3 storage and database records.

**Features**:
- **Rename Files**: Right-click any file or use the action menu to rename
- **Duplicate Prevention**: System prevents renaming to existing filenames
- **Atomic Operations**: Rename operations are transaction-safe
- **S3 Integration**: Files are renamed in both database and cloud storage
- **Validation**: Filename validation ensures proper format

**Benefits**:
- ‚úÖ Better file organization
- ‚úÖ Fix mistakes after upload
- ‚úÖ Consistent naming across the system
- ‚úÖ Safe operations with transaction support

### üë®‚Äçüíº Admin Media Management

**Problem**: Administrators had limited visibility and control over media files in the system, making it difficult to:
- Monitor system-wide media usage
- Manage files across all users
- Identify storage issues
- Clean up problematic files

**Solution**: Implemented comprehensive admin media management page with full system visibility.

**Features**:
- **System-Wide View**: See all media files across all users
- **User Filtering**: Filter media by specific user
- **Statistics Dashboard**: View media type distribution and storage statistics
- **Visual Charts**: Pie charts for media types, donut charts for storage breakdown
- **Batch Operations**: Delete multiple files at once
- **Full Permissions**: Admins can delete or rename any media file
- **Pagination**: Navigate through large media collections
- **Card and Table Views**: Switch between visual and detailed views

**Benefits**:
- ‚úÖ Complete system visibility
- ‚úÖ Easy user-specific media management
- ‚úÖ Data-driven insights with statistics
- ‚úÖ Efficient bulk operations

### üßπ Orphaned Media Management

**Problem**: Files could accumulate in S3 storage without database records, leading to:
- Storage bloat
- Wasted storage costs
- Difficulty identifying unused files
- No cleanup mechanism

**Solution**: Implemented orphaned media detection and cleanup functionality.

**Features**:
- **Orphaned Detection**: Automatically identifies files in S3 that aren't tracked in the database
- **Paginated Listing**: View orphaned files with pagination support
- **Selective Deletion**: Choose specific files to delete
- **Bulk Pruning**: Remove all orphaned files with a single action
- **Size Information**: See total size of orphaned files
- **Safe Operations**: Validates files are actually orphaned before deletion

**Administration**:
- Access via Admin ‚Üí Media ‚Üí Orphaned Files tab
- View paginated list of orphaned files
- Delete individual files or prune all at once
- See total storage that can be reclaimed

**Benefits**:
- ‚úÖ Prevents storage bloat
- ‚úÖ Reclaim unused storage space
- ‚úÖ Easy identification of orphaned files
- ‚úÖ Safe cleanup operations

### üé® Site-Level CSS Customization

**Problem**: No way to customize site appearance without modifying core code, making it difficult to:
- Apply custom branding
- Adjust colors and styles
- Match organizational design guidelines
- Customize appearance per deployment

**Solution**: Implemented site-level CSS stylesheet management similar to Moodle's appearance customization.

**Features**:
- **Multiple Stylesheets**: Add multiple external CSS stylesheets
- **Automatic Injection**: Stylesheets are automatically added to all pages
- **Cascade Control**: Order stylesheets to control CSS cascade precedence
- **URL Validation**: Only HTTP/HTTPS URLs are allowed
- **Easy Management**: Add, remove, and reorder stylesheets via admin interface
- **No Code Changes**: Customize appearance without touching core code

**Administration**:
- Configure via Admin ‚Üí Server ‚Üí Appearance
- Add multiple stylesheet URLs
- Reorder stylesheets for proper cascade
- Remove stylesheets when no longer needed

**Benefits**:
- ‚úÖ Custom branding without code changes
- ‚úÖ Multiple stylesheets for modular customization
- ‚úÖ Easy to update and maintain
- ‚úÖ Professional appearance control

### üîç Media Usage Tracking

**Problem**: No way to see where media files are being used, leading to:
- Risk of deleting files still in use
- Difficulty identifying file dependencies
- No visibility into media relationships
- Potential broken links after deletion

**Solution**: Implemented comprehensive media usage tracking with deletion protection.

**Features**:
- **Usage Detection**: See exactly where each media file is being used
- **Deletion Protection**: System prevents deletion of files that are still referenced
- **Detailed Information**: View collection, document ID, and field path for each usage
- **HTML Parsing**: Automatically extracts media references from HTML content in notes, pages, and courses
- **Usage Modal**: Click "Show Usage" to see all references to a file
- **Automatic Tracking**: Media relationships are automatically maintained when content is created or updated

**How It Works**:
- When you try to delete a file, the system checks if it's being used
- If the file is referenced anywhere, deletion is blocked with a clear error message
- You can view usage details before attempting deletion
- Media references in HTML content are automatically tracked

**Benefits**:
- ‚úÖ Prevents accidental deletion of in-use files
- ‚úÖ Clear visibility into file dependencies
- ‚úÖ Automatic relationship tracking
- ‚úÖ No broken links or missing images

---

## Bug Fixes

### Media Management Improvements
- Fixed media file creation to properly associate files with users
- Improved error handling for media operations
- Fixed transaction handling for atomic operations
- Improved validation for media filenames and uploads

### UI/UX Improvements
- Fixed React key warnings in media lists
- Improved loading states for media operations
- Better error messages for failed operations
- Fixed pagination issues in media views

### System Stability
- Improved transaction handling across media operations
- Better error recovery for S3 operations
- Fixed issues with media relationship tracking
- Improved validation for CSS stylesheet URLs

### Access Control Fixes
- Fixed missing `user` and `req` parameters in media stream functions (`tryGetMediaBufferFromFilename`, `tryGetMediaStreamFromId`)
- Removed incorrect `overrideAccess: true` usage in public media API routes
- Media file access now properly respects user permissions and access control
- Unauthenticated requests are handled correctly without bypassing security checks

---

## Migration Guide

### Database Migration Required

This update requires a single consolidated database migration that adds all new tables and fields for v0.6.0. The migration is **backward compatible** and will not affect existing functionality.

**Migration Steps**:
1. Run the migration command:
   ```bash
   bun run payload migrate
   ```
2. This will apply a single consolidated migration that creates:
   - `created_by_id` column in `media` table (for user media drive)
   - `site_policies` table (for upload limits and storage quotas)
   - `appearance_settings` table (for CSS customization)
   - Media relationship tables (`courses_rels`, `pages_rels`, `notes_rels`) for content media tracking
3. The migration is non-breaking and preserves all existing data

**What the Migration Does**:
- **Media Table Updates**: Adds `created_by_id` column with foreign key to users table and indexes for efficient querying
- **Site Policies**: Creates `site_policies` table with default values (10 GB per user, 20 MB upload limit)
- **Appearance Settings**: Creates `appearance_settings` table and related stylesheet array table with proper indexes
- **Media Relationships**: Creates relationship tables for media references in courses, pages, and notes with cascade delete and performance indexes
- All tables include proper foreign key constraints, indexes, and cascade delete rules for data integrity

**After Migration**:
- ‚úÖ All existing functionality continues to work
- ‚úÖ Default policies are applied (10 GB per user, 20 MB upload limit)
- ‚úÖ Appearance settings default to empty (no custom stylesheets)
- ‚úÖ Media usage tracking is automatically enabled
- ‚úÖ No configuration changes needed immediately

### New Features Setup

**User Media Drive**:
- Accessible from User menu ‚Üí Media Drive
- No setup required - automatically available for all users
- Storage quota is enforced based on site policies

**Site Policies**:
- Configure via Admin ‚Üí Server ‚Üí Site Policies
- Set upload limits and storage quotas
- Defaults are applied automatically

**Appearance Customization**:
- Configure via Admin ‚Üí Server ‚Üí Appearance
- Add external CSS stylesheet URLs
- Changes take effect immediately

**Admin Media Management**:
- Accessible via Admin ‚Üí Media
- View all media or filter by user
- Statistics are automatically calculated

**Orphaned Media Cleanup**:
- Accessible via Admin ‚Üí Media ‚Üí Orphaned Files tab
- Review orphaned files before cleanup
- Use selective deletion or bulk prune

---

## Breaking Changes

None. All changes are backward compatible.

---

## Dependencies

No new major dependencies added in this release. Minor updates to existing packages for improved stability.

---

## Testing

### User Media Drive
- ‚úÖ Media upload works correctly
- ‚úÖ File preview displays correctly for all types
- ‚úÖ Rename functionality works
- ‚úÖ Delete operations are safe
- ‚úÖ Storage quota enforcement works
- ‚úÖ Pagination works correctly
- ‚úÖ Search and filter work properly

### Site Policies
- ‚úÖ Upload limits are enforced
- ‚úÖ Storage quotas are enforced
- ‚úÖ Unlimited options work correctly
- ‚úÖ Audio/video streaming works
- ‚úÖ Preview functionality works

### Admin Media Management
- ‚úÖ System-wide view displays correctly
- ‚úÖ User filtering works
- ‚úÖ Statistics are accurate
- ‚úÖ Charts display correctly
- ‚úÖ Batch operations work

### Orphaned Media
- ‚úÖ Detection is accurate
- ‚úÖ Pagination works
- ‚úÖ Deletion is safe
- ‚úÖ Bulk prune works

### CSS Customization
- ‚úÖ Stylesheets are injected correctly
- ‚úÖ Ordering works for cascade
- ‚úÖ URL validation works
- ‚úÖ Changes take effect immediately

### Media Usage Tracking
- ‚úÖ Usage detection is accurate
- ‚úÖ Deletion protection works
- ‚úÖ HTML parsing works correctly
- ‚úÖ Relationship tracking is automatic

---

## Technical Details

### Media Management Architecture

The media management system is built on a foundation of:
- **User Association**: Every media file is linked to its creator
- **S3 Integration**: Files are stored in cloud storage with database tracking
- **Transaction Safety**: All operations use transactions for atomicity
- **Usage Tracking**: Automatic detection of media references across the system
- **Access Control**: Permission-based access with admin overrides

### HTML Media Parsing

The system automatically extracts media references from HTML content:
- Parses `<img>` tags with `/api/media/file/:filenameOrId` URLs
- Supports both numeric IDs and filenames
- Resolves filenames to IDs within transaction context
- Updates media relationship fields automatically

### Storage Management

Storage is managed through:
- Per-user quotas configured in site policies
- Real-time usage tracking
- Orphaned file detection
- Bulk cleanup operations

---

## Thank You

Thank you for using Paideia LMS. This release represents a major step forward in media management capabilities, providing both users and administrators with powerful tools for managing files throughout the platform. The new features make the system more flexible, easier to customize, and better equipped for production use.

For questions, issues, or contributions, please visit our GitHub repository: https://github.com/paideia-lms/paideia

---

## Complete Changelog Reference

This release includes all changes from changelogs 0040 through 0046:

### User Media Drive (0040)
- **0040** - User Media Drive: Personal media library for all users
- **0040** - Media Collection Updates: Added `createdBy` field to track file ownership
- **0040** - Media Management Functions: Functions for querying and managing user media
- **0040** - User Media Page: Complete UI for media drive with card and table views

### Site Policies and Upload Limits (0041)
- **0041** - Site Policies Global: Configurable upload limits and storage quotas
- **0041** - Unified System Globals: Efficient parallel fetching of system settings
- **0041** - Upload Limit Enforcement: Real-time validation at upload point
- **0041** - Audio/Video Streaming: HTTP Range request support for progressive loading
- **0041** - Media Preview: Inline and full-size previews for all media types

### Media Rename Functionality (0042)
- **0042** - Rename Function: Rename files in both S3 and database
- **0042** - Duplicate Prevention: Prevents renaming to existing filenames
- **0042** - UI Integration: Rename modal in media drive

### Admin Media Management (0043)
- **0043** - Admin Media Page: System-wide media view with user filtering
- **0043** - Media Statistics: System-wide statistics with charts
- **0043** - User Filtering: Filter media by user with search parameters

### Orphaned Media Management (0044)
- **0044** - Orphaned Detection: Identify files in S3 not tracked in database
- **0044** - Selective Deletion: Delete specific orphaned files
- **0044** - Bulk Pruning: Remove all orphaned files at once

### Site-Level CSS Customization (0045)
- **0045** - Appearance Settings: Global configuration for CSS stylesheets
- **0045** - Stylesheet Management: Add, remove, and reorder stylesheets
- **0045** - Automatic Injection: Stylesheets added to all pages automatically

### Media Usage Tracking (0046)
- **0046** - Usage Detection: Find all references to media files
- **0046** - Deletion Protection: Prevent deletion of in-use files
- **0046** - HTML Parsing: Automatic extraction of media references from HTML
- **0046** - Usage Modal: View usage details before deletion
- **0046** - Relationship Tracking: Automatic media relationship management

**Full Changelog Details**: See changelog files:
- `changelogs/0040-2025-11-10-user-media-drive.md` for user media drive details
- `changelogs/0041-2025-11-10-site-policies-and-upload-limits.md` for site policies and streaming
- `changelogs/0042-2025-11-11-media-rename-functionality.md` for rename functionality
- `changelogs/0043-2025-11-11-admin-media-management.md` for admin media management
- `changelogs/0044-2025-11-11-orphaned-media-management.md` for orphaned media cleanup
- `changelogs/0045-2025-11-11-site-level-additional-css-stylesheets.md` for CSS customization
- `changelogs/0046-2025-11-11-media-usage-tracking.md` for usage tracking and deletion protection


# Release Notes - Paideia LMS v0.5.1

**Release Date:** November 3, 2025
**Version:** 0.5.1
**Type**: Bug Fix
**Impact**: High - Fixes critical cookie domain handling issues preventing login on non-localhost domains
**Changelog**: 0032

## Overview

Paideia LMS v0.5.1 is a patch release that fixes critical cookie domain handling issues preventing login on non-localhost domains. This release also includes important infrastructure improvements for PostgreSQL 18+ compatibility, development host configuration, enhanced release workflow, and platform-aware build system.

---

## Critical Fixes

## Overview

Paideia LMS v0.5.1 is a patch release that fixes critical cookie domain handling issues preventing login on non-localhost domains. This release also includes important infrastructure improvements for PostgreSQL 18+ compatibility, development host configuration, enhanced release workflow, and platform-aware build system.

---

## Critical Fixes

### üîê Cookie Domain Fix

**Problem**: Login was not working on non-localhost domains (e.g., `paideia-13.localcan.dev`) because cookies were not being set correctly.

**Root Causes**:
- Cookie domain extraction was incorrect (using full URLs instead of domain names)
- Secure flag was always enabled, preventing cookies in HTTP development environments
- Domain was not properly set for subdomains

**Solutions**:

#### Proper Domain Extraction
- **Fixed domain extraction** from origin headers and URLs
- **Subdomain support**: For subdomains like `paideia-13.localcan.dev`, domain is now set to `.localcan.dev` (with leading dot for subdomain sharing)
- **Localhost handling**: Domain is omitted entirely for localhost (as required by browsers)
- **Regular domains**: Uses domain name directly for production domains

#### Secure Flag Logic
- **Conditional secure flag**: Only uses secure flag when HTTPS is available
- **Development-friendly**: Allows non-secure cookies for development domains (localhost, 127.0.0.1, `.localcan.dev`)
- **Production-secure**: Requires HTTPS for production domains

**Affected Functions**:
- ‚úÖ `setCookie()` - Authentication token cookies
- ‚úÖ `removeCookie()` - Cookie removal
- ‚úÖ `setImpersonationCookie()` - Impersonation cookies
- ‚úÖ `removeImpersonationCookie()` - Impersonation cookie removal

**Benefits**:
- ‚úÖ Login now works correctly on non-localhost domains
- ‚úÖ Cookies work across subdomains (e.g., all `*.localcan.dev` subdomains)
- ‚úÖ Development-friendly (works with HTTP in development)
- ‚úÖ Production-secure (requires HTTPS in production)

**Example**:
```typescript
// Before: Cookies failed on "paideia-13.localcan.dev"
// After: Cookies work correctly with domain ".localcan.dev"
```

---

## Infrastructure Improvements

### üêò PostgreSQL 18+ Docker Compose Compatibility

**Problem**: PostgreSQL 18+ changed its data directory structure, causing restart loops with the old volume mount path.

**Solution**:
- Updated volume mount from `/var/lib/postgresql/data` to `/var/lib/postgresql`
- Added healthcheck to verify database readiness
- Container now automatically creates version-specific data directory (`/var/lib/postgresql/18/data`)

**Benefits**:
- ‚úÖ Fixes restart loop issues with PostgreSQL 18+
- ‚úÖ Supports future major version upgrades using `pg_upgrade --link`
- ‚úÖ Better health monitoring with automatic healthchecks

**Migration**: If you have existing data, see the [Migration Guide](#migration-guide) section below.

### üåê Development Host Configuration

**Features**:
- Added wildcard support for all `*.localcan.dev` subdomains in Vite configuration
- Allows development with local tunneling services without manual configuration
- No need to add individual subdomains manually

**Configuration**:
```typescript
// vite.config.mts
server: {
  allowedHosts: [".localcan.dev"],
}
```

### üöÄ Enhanced Release Workflow

**Features**:
- **Docker Hub Publishing**: Automatically publishes to both GitHub Container Registry and Docker Hub
- **Docker Image Existence Check**: Skips build if image with same version tag already exists (saves CI/CD time)
- **Multi-Platform Binary Support**: Builds binaries for macOS ARM64, Linux ARM64, Linux x64, and Windows x64
- **Release Notes Integration**: Automatically includes release notes from `release-notes/` directory in GitHub releases

**Benefits**:
- ‚úÖ Faster CI/CD runs (skips unnecessary builds)
- ‚úÖ Broader distribution (both GHCR and Docker Hub)
- ‚úÖ Multi-platform support out of the box
- ‚úÖ Better release documentation

### üñ•Ô∏è Platform-Aware Build System

**Features**:
- **OS Detection**: Automatically detects current platform and architecture
- **Platform-Aware Building**: Builds only for current platform locally, all platforms in CI
- **OS Information Logging**: Logs platform, architecture, CPU model, memory, and uptime for debugging

**Benefits**:
- ‚úÖ Faster local builds (only builds for current platform)
- ‚úÖ Automatic platform detection (no manual configuration)
- ‚úÖ Consistent CI builds (all platforms built automatically)
- ‚úÖ Better debugging with OS information

**Build Modes**:
```bash
# Local build (current platform only)
bun run build

# CI build (all platforms)
BUILD_ALL_PLATFORMS=true bun run build
```

---

## Bug Fixes

### Cookie Handling
- ‚úÖ Fixed cookies not setting on non-localhost domains
- ‚úÖ Fixed domain extraction from origin headers
- ‚úÖ Fixed secure flag preventing cookies in HTTP development environments
- ‚úÖ Fixed subdomain cookie sharing (e.g., all `*.localcan.dev` subdomains)

### PostgreSQL
- ‚úÖ Fixed restart loop with PostgreSQL 18+
- ‚úÖ Fixed volume mount path compatibility

### Release Workflow
- ‚úÖ Fixed Docker Hub push failures (using authenticated username)
- ‚úÖ Fixed build failures on unsupported platforms (platform detection)

---

## Migration Guide

### PostgreSQL 18+ Upgrade

If you have existing data in the old volume structure:

1. **Stop services**:
   ```bash
   docker compose down
   ```

2. **Migrate data** (if needed):
   ```bash
   docker run --rm \
     -v <project_name>_postgres_data:/var/lib/postgresql \
     postgres:18 \
     sh -c "mkdir -p /var/lib/postgresql/18 && mv /var/lib/postgresql/data/* /var/lib/postgresql/18/data/ 2>/dev/null || true && chown -R 999:999 /var/lib/postgresql/18"
   ```

3. **Update `docker-compose.yml`**: Ensure volume mount is `/var/lib/postgresql` (not `/var/lib/postgresql/data`)

4. **Restart services**:
   ```bash
   docker compose up -d
   ```

**Note**: If you're starting fresh, just update `docker-compose.yml` and restart - no migration needed.

### Cookie Configuration

**No manual migration needed.** The changes are automatic and backward compatible:

- ‚úÖ Localhost continues to work (domain omitted)
- ‚úÖ Non-localhost domains now work correctly
- ‚úÖ Subdomain sharing works automatically (e.g., `.localcan.dev`)

### Build System

**No changes needed** for existing workflows:

- ‚úÖ Local builds automatically detect platform
- ‚úÖ CI builds use `BUILD_ALL_PLATFORMS=true` environment variable
- ‚úÖ Existing build scripts continue to work

---

## Breaking Changes

None. All changes are backward compatible.

---

## Dependencies

No new dependencies added.

---

## Testing

- ‚úÖ Cookies set correctly on localhost and non-localhost domains
- ‚úÖ Cookies work across subdomains (e.g., all `*.localcan.dev` subdomains)
- ‚úÖ Login works on non-localhost domains
- ‚úÖ PostgreSQL 18+ starts correctly with new volume mount
- ‚úÖ Build system detects platform correctly
- ‚úÖ CI builds all platforms when `BUILD_ALL_PLATFORMS=true`
- ‚úÖ Docker Hub publishing works with authenticated username
- ‚úÖ Release notes integrated into GitHub releases

---

## Future Enhancements

- Support for additional platforms (e.g., Linux ARM32)
- Option to specify build targets manually
- Enhanced cookie domain configuration
- PostgreSQL major version upgrade automation

---

## Contributors

This release represents improvements across multiple areas:
- Infrastructure and deployment
- Cookie and authentication handling
- Development workflow
- CI/CD pipeline

---

## Thank You

Thank you for using Paideia LMS. This patch release addresses critical login issues and improves the development experience. We're committed to continuing to improve the platform based on your feedback.

For questions, issues, or contributions, please visit our GitHub repository: https://github.com/paideia-lms/paideia

---

## Complete Changelog Reference

This release includes all changes from changelog 0032:

### Infrastructure & Development Improvements (0032)
- **0032** - Infrastructure and Development Improvements: PostgreSQL 18+ compatibility, development host configuration, cookie domain fixes, enhanced release workflow, and platform-aware build system

### Detailed Changelog

#### PostgreSQL 18+ Docker Compose Compatibility
- Updated volume mount from `/var/lib/postgresql/data` to `/var/lib/postgresql`
- Added healthcheck to verify database readiness
- Container now automatically creates version-specific data directory (`/var/lib/postgresql/18/data`)
- Fixes restart loop issues with PostgreSQL 18+
- Supports future major version upgrades using `pg_upgrade --link`

#### Development Host Configuration
- Added wildcard support for all `*.localcan.dev` subdomains in Vite configuration
- Allows development with local tunneling services without manual configuration
- No need to add individual subdomains manually

#### Cookie Domain and Security Fixes
- Fixed cookie handling for non-localhost domains
- Proper domain extraction from origin headers and URLs
- For subdomains (e.g., `paideia-13.localcan.dev`), sets domain to `.localcan.dev` (with leading dot for subdomain sharing)
- For localhost, omits domain entirely (as required by browsers)
- Conditional secure flag: Only uses secure flag when HTTPS is available
- Development-friendly: Allows non-secure cookies for development domains
- Production-secure: Requires HTTPS for production domains
- Affects all cookie functions: `setCookie()`, `removeCookie()`, `setImpersonationCookie()`, `removeImpersonationCookie()`

#### Enhanced Release Workflow
- Docker Hub Publishing: Automatically publishes to both GitHub Container Registry and Docker Hub
- Docker Image Existence Check: Skips build if image with same version tag already exists (saves CI/CD time)
- Multi-Platform Binary Support: Builds binaries for macOS ARM64, Linux ARM64, Linux x64, and Windows x64
- Release Notes Integration: Automatically includes release notes from `release-notes/` directory in GitHub releases
- Uses Docker Hub username from secrets (no hardcoded organization)

#### Platform-Aware Build System
- OS Detection: Automatically detects current platform and architecture
- OS Information Logging: Logs platform, architecture, hostname, CPU model, memory, and uptime for debugging
- Platform-Aware Building: Builds only for current platform locally, all platforms in CI
- Conditional Building: Uses `BUILD_ALL_PLATFORMS=true` environment variable for CI builds
- Supports: macOS ARM64, macOS x64, Linux ARM64, Linux x64, Windows x64

---

**Full Changelog Details**: See changelog file `changelogs/0032-2025-11-03-infrastructure-and-development-improvements.md` for detailed information about each feature and change.


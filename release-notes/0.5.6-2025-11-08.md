# Release Notes - Paideia LMS v0.5.6

**Release Date:** November 8, 2025  
**Version:** 0.5.6  
**Type**: Feature Addition / Enhancement  
**Impact**: High - Adds job history visibility and system-wide maintenance mode for better operational control  
**Changelog**: 0038, 0039

## Overview

Paideia LMS v0.5.6 introduces two major features that significantly improve system observability and operational control. The release adds comprehensive cron job history display, allowing administrators to track job execution patterns and debug failures. Additionally, a new maintenance mode feature provides administrators with the ability to restrict system access during maintenance periods, ensuring controlled access while preventing infinite redirect loops.

---

## Features Added

### ðŸ“Š Cron Job History Display

**Problem**: Administrators had no visibility into cron job execution history, making it difficult to:
- Track job execution patterns
- Debug failed jobs
- Monitor system performance
- Understand job execution status

**Solution**: Added comprehensive job history display to the admin cron jobs page with detailed execution information.

**Features**:
- **Complete History**: View all job executions, including both successful and failed jobs
- **Detailed Information**: See execution timestamps, state, and error messages
- **Database Integration**: Retrieves history directly from `payload_jobs` and `payload_jobs_log` tables using Drizzle ORM
- **Smart Querying**: Uses left join to include all jobs, even when log entries don't exist (PostgreSQL behavior)
- **Enhanced Error Display**: CodeHighlight component for better error readability with copy functionality
- **Configurable Limit**: Default 100 entries, configurable in function

**Technical Details**:
- Created `tryGetCronJobHistory()` function in `server/internal/cron-jobs-management.ts`
- Query uses left join to handle PostgreSQL's logging behavior (only logs failures)
- Fallback logic derives state and timestamps from `payload_jobs` when logs are missing
- Returns structured `CronJobHistoryEntry` objects with execution details
- Integrated into existing `tryGetCronJobs()` function

**UI Components**:
- Job history table with columns: Job name, Task slug, Queue, Executed at, Completed at, State, Error
- State badges: Green for succeeded, Red for failed
- CodeHighlight component for formatted error display (supports string and JSON)
- Responsive layout with proper spacing

**Benefits**:
- âœ… Complete visibility into job execution history
- âœ… Easy identification of failed jobs
- âœ… Detailed error information for troubleshooting
- âœ… Better user experience with formatted error display
- âœ… Performance monitoring capabilities
- âœ… Handles PostgreSQL-specific logging behavior

**Example**:
```
Job History Table:
- Job: Queue: nightly | State: Succeeded | Executed: Nov 8, 2025 12:00 AM
- Job: Task: sandboxReset | State: Failed | Error: [detailed error message]
```

### ðŸ”§ Maintenance Mode

**Problem**: No way to restrict system access during maintenance periods, leading to:
- Users accessing the system during maintenance
- Potential data inconsistencies
- No controlled access mechanism
- Risk of infinite redirect loops

**Solution**: Implemented comprehensive maintenance mode feature with admin controls and proper error handling.

**Features**:
- **System-Wide Control**: Toggle maintenance mode via admin interface
- **Admin Access**: Administrators can still access the system during maintenance
- **User-Friendly Messages**: Clear maintenance messages with login link
- **Infinite Loop Prevention**: Smart redirect logic prevents infinite loops
- **Error Boundaries**: Proper error handling with user-friendly display
- **API Access**: API routes remain accessible during maintenance

**Technical Details**:
- Created `MaintenanceSettings` global in Payload CMS
- Single boolean field `maintenanceMode` (default: false)
- Admin page at `/admin/maintenance` for managing maintenance mode
- Middleware checks maintenance mode status in root middleware
- `MaintenanceModeResponse` error class (HTTP 503 Service Unavailable)
- `RootErrorBoundary` component for displaying maintenance messages

**Access Control**:
- **Allowed during maintenance**:
  - `/login` - For administrators to log in
  - `/admin/maintenance` - For administrators to disable maintenance mode
  - `/api/*` - For API access
- **Blocked during maintenance**:
  - All other routes for non-admin users
  - Root route (`/`) shows maintenance message for non-admin users

**Infinite Loop Prevention**:
- Checks if already on root route before redirecting
- If on root route, throws error instead of redirecting
- Error boundary displays maintenance message
- Prevents redirect loop

**Benefits**:
- âœ… Controlled access during maintenance periods
- âœ… Administrators can still access system
- âœ… Clear messaging to users
- âœ… No infinite redirect loops
- âœ… Easy to enable/disable via admin interface
- âœ… Professional error display

**Example**:
```
Maintenance Mode Enabled:
- Non-admin users see: "System Under Maintenance" message
- Administrators can access all routes normally
- Login page accessible for admin login
- Admin can disable maintenance mode from admin page
```

---

## Bug Fixes

### Infinite Redirect Loop Prevention

**Problem**: When maintenance mode was enabled, non-admin users were redirected to root route, which then redirected again, creating an infinite loop.

**Solution**: Added check to detect if already on root route and throw error instead of redirecting.

**Benefits**:
- âœ… No infinite redirect loops
- âœ… Proper error display
- âœ… Better user experience

---

## Migration Guide

### No Migration Required

This update is **backward compatible**. Existing installations will continue to work:

- âœ… All existing functionality continues to work
- âœ… Maintenance mode defaults to disabled
- âœ… Job history is automatically available
- âœ… No configuration changes needed
- âœ… No database migrations required

### New Features

**Cron Job History**:
- Job history is automatically displayed on the admin cron jobs page
- History limit defaults to 100 entries (configurable)
- History is sorted by most recent first

**Maintenance Mode**:
- Maintenance mode can be enabled/disabled via Admin â†’ Server â†’ Maintenance mode
- Maintenance mode defaults to disabled
- No additional configuration needed

---

## Breaking Changes

None. All changes are backward compatible.

---

## Dependencies

No new dependencies added in this release.

---

## Testing

### Cron Job History
- âœ… Job history displays correctly for all job types
- âœ… History includes both successful and failed jobs
- âœ… Error messages display correctly (string and object formats)
- âœ… Timestamps format correctly
- âœ… Job names derive correctly from task slug or queue
- âœ… History limit works correctly
- âœ… Query handles missing log entries gracefully
- âœ… Fallback logic works correctly
- âœ… CodeHighlight component displays errors properly
- âœ… Copy functionality works for error messages

### Maintenance Mode
- âœ… Maintenance mode can be enabled via admin page
- âœ… Maintenance mode can be disabled via admin page
- âœ… Non-admin users are blocked when maintenance mode is enabled
- âœ… Administrators can access system when maintenance mode is enabled
- âœ… Login page is accessible during maintenance mode
- âœ… Admin maintenance page is accessible during maintenance mode
- âœ… API routes are accessible during maintenance mode
- âœ… Root route shows maintenance message for non-admin users
- âœ… No infinite redirect loops occur
- âœ… Error boundary displays maintenance message correctly
- âœ… Error boundary falls back to default for other errors
- âœ… Page info flags are set correctly
- âœ… Admin layout tab detection works correctly
- âœ… Route configuration is correct

---

## Technical Details

### Cron Job History Implementation

**Database Query**:
```typescript
const history = await drizzle
  .select({
    jobId: payload_jobs.id,
    logId: payload_jobs_log.id,
    taskSlug: payload_jobs.taskSlug,
    queue: payload_jobs.queue,
    // ... more fields
  })
  .from(payload_jobs)
  .leftJoin(
    payload_jobs_log,
    eq(payload_jobs_log._parentID, payload_jobs.id),
  )
  .orderBy(desc(payload_jobs.createdAt))
  .limit(historyLimit);
```

**Fallback Logic**:
- Uses `logExecutedAt` if available, otherwise `jobCreatedAt` or `jobCompletedAt`
- Uses `logCompletedAt` if available, otherwise `jobCompletedAt`
- Uses `logState` if available, otherwise derives from `jobHasError` flag
- Uses `logError` if available, otherwise `jobError`

**Why Left Join?**:
- PostgreSQL only creates log entries in `payload_jobs_log` for failed jobs
- Left join ensures all jobs from `payload_jobs` are included
- Fallback logic handles cases where logs don't exist

### Maintenance Mode Implementation

**Middleware Check**:
```typescript
// Check maintenance mode
if (maintenanceMode) {
  // Allow access to login and admin maintenance page
  if (pageInfo.isLogin || pageInfo.isAdminMaintenance || pageInfo.isApi) {
    return;
  }
  
  // Block non-admin users
  if (!currentUser || currentUser.role !== "admin") {
    // If already on root route, throw error instead of redirecting
    if (pageInfo.isDashboard) {
      throw new MaintenanceModeResponse(...);
    }
    // Otherwise, redirect to root route
    throw redirect(href("/"));
  }
}
```

**Error Response**:
```typescript
export class MaintenanceModeResponse extends Response {
  constructor(message: string = "The system is currently under maintenance...") {
    super(message, {
      status: StatusCode.ServiceUnavailable, // 503
      statusText: "Service Unavailable",
    });
  }
}
```

**Error Boundary**:
- `RootErrorBoundary` component checks for 503 status
- Displays maintenance message with icon and styling
- Provides link to login page
- Falls back to `DefaultErrorBoundary` for other errors

### Page Info Updates

**New Flags**:
- `isAdminMaintenance`: Detects admin maintenance page route
- `isApi`: Detects API routes (replaces path string checks)

**Benefits**:
- Consistent route detection
- Proper tab highlighting in admin layout
- Cleaner code (no path string checks)

---

## Thank You

Thank you for using Paideia LMS. This release adds important operational features that improve system observability and control. The cron job history display provides administrators with complete visibility into job execution patterns, while the maintenance mode feature ensures controlled access during maintenance periods.

For questions, issues, or contributions, please visit our GitHub repository: https://github.com/paideia-lms/paideia

---

## Complete Changelog Reference

This release includes all changes from changelogs 0038 and 0039:

### Cron Job History Display (0038)
- **0038** - Cron Job History Function: Added `tryGetCronJobHistory()` function for retrieving job history
- **0038** - Job History Display: Added job history table to admin cron jobs page
- **0038** - Database Query Optimization: Optimized query to handle PostgreSQL logging behavior
- **0038** - Enhanced Error Display: CodeHighlight component for better error readability

### Maintenance Mode (0039)
- **0039** - Maintenance Settings Global: Created `MaintenanceSettings` global in Payload CMS
- **0039** - Admin Maintenance Page: Created admin page for managing maintenance mode
- **0039** - Maintenance Mode Middleware: Added maintenance mode check in root middleware
- **0039** - Maintenance Mode Error Response: Created `MaintenanceModeResponse` error class
- **0039** - Root Error Boundary: Created `RootErrorBoundary` component for maintenance messages
- **0039** - Infinite Loop Prevention: Smart redirect logic prevents infinite loops

### Detailed Changelog

#### Cron Job History Display
- Created `tryGetCronJobHistory()` function in `server/internal/cron-jobs-management.ts`
- Added `CronJobHistoryEntry` interface with execution details
- Updated `GetCronJobsResult` interface to include `jobHistory`
- Query uses left join to include all jobs, even without log entries
- Fallback logic derives state and timestamps from `payload_jobs` when logs are missing
- Added job history table to admin cron jobs page
- Enhanced error display using Mantine CodeHighlight component
- Added helper functions: `formatDateString()` and `getJobName()`

#### Maintenance Mode
- Created `MaintenanceSettings` global with `maintenanceMode` boolean field
- Created `server/internal/maintenance-settings.ts` with helper functions
- Created `app/routes/admin/maintenance.tsx` admin page
- Added maintenance mode middleware in `app/root.tsx`
- Created `MaintenanceModeResponse` error class (HTTP 503)
- Created `RootErrorBoundary` component for maintenance messages
- Added `isAdminMaintenance` flag to `PageInfo` type
- Added `isApi` flag to `PageInfo` type (replaces path string checks)
- Added route configuration for `/admin/maintenance`
- Added link to maintenance page in admin index
- Implemented infinite redirect loop prevention

---

**Full Changelog Details**: See changelog files:
- `changelogs/0038-2025-11-08-cron-job-history-display.md` for detailed information about cron job history display
- `changelogs/0039-2025-11-08-maintenance-mode.md` for detailed information about maintenance mode


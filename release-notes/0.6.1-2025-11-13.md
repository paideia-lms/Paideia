# Release Notes - Paideia LMS v0.6.1

**Release Date:** November 13, 2025  
**Version:** 0.6.1  
**Type**: Bug Fix / Patch Release  
**Impact**: Critical - Fixes critical migration bug from v0.6.0 and resolves access control issues  
**Changelog**: 0047, 0048

## Overview

Paideia LMS v0.6.1 is a critical patch release that fixes a migration bug in v0.6.0 that prevented the server from starting. This release also includes two important improvements: package version display in the admin system information page and a fix for orphaned media access control issues. **All users should upgrade to v0.6.1 instead of v0.6.0.**

---

## Critical Fixes

### üîß Migration Bug Fix

**Problem**: v0.6.0 contained a critical migration bug that prevented the database migration from completing successfully, causing the server to fail to start.

**Solution**: Fixed the migration script with improved error handling and a more robust data population strategy for adding the `created_by_id` column to the `media` table.

**What Was Fixed**:
- Improved handling of existing data when adding NOT NULL columns
- Better error messages for migration failures
- More robust user assignment logic for existing media files
- Proper handling of edge cases (empty databases, no users, etc.)
- Enhanced validation to ensure all media rows have valid user IDs before setting NOT NULL constraint

**Impact**:
- ‚úÖ Server now starts successfully after upgrade
- ‚úÖ Migration completes without errors
- ‚úÖ All existing media files are properly associated with users
- ‚úÖ No data loss during migration

**For Users**:
- If you attempted to upgrade to v0.6.0 and it failed, your system should have automatically rolled back to v0.5.6
- Upgrade directly to v0.6.1 - no data loss should have occurred
- If you haven't upgraded yet, skip v0.6.0 and go directly to v0.6.1

**Related**: See [Incident Report: v0.6.0 Migration Failure](./incidents/2025-11-12-v0-6-0-migration-failure.md) for full details.

---

## Bug Fixes

### üîê Orphaned Media Access Control Fix

**Problem**: Orphaned media management functions were missing required access control parameters (`user`, `req`, `overrideAccess`), causing "Forbidden: You are not allowed to perform this action" errors when attempting to view or manage orphaned media files.

**Solution**: Added missing access control parameters to all orphaned media management functions to follow the project's standardized access control patterns.

**Functions Fixed**:
- `tryGetOrphanedMedia` - Fetch paginated list of orphaned media files
- `tryGetAllOrphanedFilenames` - Get all orphaned filenames without pagination
- `tryPruneAllOrphanedMedia` - Delete all orphaned media files
- `tryDeleteOrphanedMedia` - Delete specific orphaned media files

**What Changed**:
- Added `user`, `req`, and `overrideAccess` parameters to all function signatures
- Removed hardcoded `overrideAccess: true` from internal Payload calls
- Functions now properly respect access control based on user context
- Enabled transaction support for atomic operations

**Impact**:
- ‚úÖ Admin users can now view orphaned media files without errors
- ‚úÖ Admin users can delete orphaned media files successfully
- ‚úÖ Functions follow standardized access control patterns
- ‚úÖ Transaction support enabled for safe operations
- ‚úÖ Consistent with all other internal functions in the codebase

**Related**: See [Changelog 0048](../changelogs/0048-2025-11-12-orphaned-media-access-control-fix.md) for technical details.

---

## Features Added

### üì¶ Package Version Display

**Problem**: Administrators had no easy way to identify the current application version, making debugging and support more difficult.

**Solution**: Added package version display to the admin system information page, reading directly from `package.json`.

**Features**:
- **Version Display**: Shows current package version in a dedicated "Application" section
- **Automatic Updates**: Version updates automatically when `package.json` version changes
- **Centralized Storage**: Version stored in global context for application-wide access
- **Consistent UI**: Follows the same design pattern as other system information sections

**Where to Find It**:
- Admin ‚Üí System ‚Üí Application section
- Displays version `0.6.1` (or current version)
- Located after the "Runtime" section

**Benefits**:
- ‚úÖ Quick version identification for administrators
- ‚úÖ Useful for debugging and support purposes
- ‚úÖ Single source of truth for application version
- ‚úÖ Easy to access from any route or component

**Related**: See [Changelog 0047](../changelogs/0047-2025-11-12-package-version-display.md) for technical details.

---

## Migration Guide

### Database Migration Required

This release includes a **fixed migration** that replaces the broken migration from v0.6.0. The migration is **backward compatible** and will not affect existing functionality.

**Migration Steps**:
1. Ensure you are on v0.5.6 or earlier (if you attempted v0.6.0, you should have been rolled back automatically)
2. Upgrade to v0.6.1
3. The migration will be automatically applied when you start the server, or you can manually run:
   ```bash
   paideia migrate up
   ```
4. The migration will:
   - Add `created_by_id` column to `media` table (with proper data population)
   - Create `site_policies` table (for upload limits and storage quotas)
   - Create `appearance_settings` table (for CSS customization)
   - Create media relationship tables (`courses_rels`, `pages_rels`, `notes_rels`) for content media tracking

**What the Migration Does**:
- **Media Table Updates**: Adds `created_by_id` column with proper handling of existing data
- **Data Population**: Safely assigns existing media files to users (admin users first, then any user)
- **Site Policies**: Creates `site_policies` table with default values (10 GB per user, 20 MB upload limit)
- **Appearance Settings**: Creates `appearance_settings` table and related stylesheet array table
- **Media Relationships**: Creates relationship tables for media references in courses, pages, and notes
- All tables include proper foreign key constraints, indexes, and cascade delete rules

**After Migration**:
- ‚úÖ Server starts successfully
- ‚úÖ All existing functionality continues to work
- ‚úÖ Default policies are applied (10 GB per user, 20 MB upload limit)
- ‚úÖ Appearance settings default to empty (no custom stylesheets)
- ‚úÖ Media usage tracking is automatically enabled
- ‚úÖ All existing media files are properly associated with users

---

## Breaking Changes

None. All changes are backward compatible.

---

## Dependencies

No new dependencies added in this release.

---

## Testing

### Migration
- ‚úÖ Migration completes successfully on fresh installations
- ‚úÖ Migration completes successfully on existing databases
- ‚úÖ All existing media files are properly assigned to users
- ‚úÖ No data loss during migration
- ‚úÖ Server starts successfully after migration

### Orphaned Media Access Control
- ‚úÖ Admin users can view orphaned media files
- ‚úÖ Admin users can delete orphaned media files
- ‚úÖ Access control is properly enforced
- ‚úÖ Transaction support works correctly

### Package Version Display
- ‚úÖ Version displays correctly in admin system page
- ‚úÖ Version updates when package.json changes
- ‚úÖ Version is accessible from global context

---

## Technical Details

### Migration Improvements

The fixed migration includes several improvements over v0.6.0:

1. **Better Data Handling**: Safely handles cases where no users exist or no admin users exist
2. **Robust User Assignment**: Tries admin users first, then falls back to any user
3. **Proper Validation**: Ensures all media rows have valid user IDs before setting NOT NULL
4. **Error Handling**: Improved error messages for debugging migration issues
5. **Transaction Safety**: All operations are wrapped in transactions for atomicity

### Access Control Standardization

All internal functions now follow a consistent pattern:
- Accept `user?: TypedUser | null` for user context
- Accept `req?: Partial<PayloadRequest>` for transaction support
- Accept `overrideAccess?: boolean` to control access control enforcement
- Default to `overrideAccess = false` to enforce access control by default

This ensures consistent security behavior across the entire codebase.

---

## Upgrade Instructions

### From v0.5.6 or Earlier

1. **Check migration status** (optional):
   ```bash
   paideia migrate status
   ```

2. **Upgrade to v0.6.1**:
   ```bash
   git pull origin main  # or your branch
   ```

3. **Start the server** (migration will be applied automatically):
   ```bash
   paideia start
   ```
   
   Or manually apply the migration first:
   ```bash
   paideia migrate up
   paideia start
   ```

### From v0.6.0 (Failed Upgrade)

If you attempted to upgrade to v0.6.0 and it failed:

1. **Verify rollback**: Check that you're on v0.5.6:
   ```bash
   paideia migrate status
   ```

2. **Upgrade to v0.6.1**:
   ```bash
   git pull origin main  # or your branch
   ```

3. **Start the server** (migration will be applied automatically):
   ```bash
   paideia
   ```
   
   Or manually apply the fixed migration first:
   ```bash
   paideia migrate up
   paideia
   ```

**Note**: No data loss should have occurred due to Payload's automatic rollback mechanism.

---

## Thank You

Thank you for using Paideia LMS. We apologize for the inconvenience caused by the migration bug in v0.6.0. This patch release (v0.6.1) resolves all known issues and provides a stable upgrade path with all the features from v0.6.0.

For questions, issues, or contributions, please visit our GitHub repository: https://github.com/paideia-lms/paideia

---

## Complete Changelog Reference

This release includes changes from changelogs 0047 and 0048:

### Package Version Display (0047)
- **0047** - Package Version Display: Shows current version in admin system information page
- **0047** - Global Context: Version stored in global context for application-wide access
- **0047** - UI Integration: New "Application" section in system information page

### Orphaned Media Access Control Fix (0048)
- **0048** - Access Control Fix: Added missing parameters to orphaned media functions
- **0048** - Function Standardization: All functions now follow consistent access control patterns
- **0048** - Transaction Support: Enabled transaction support for atomic operations
- **0048** - Bug Fix: Resolved "Forbidden" errors when managing orphaned media

**Full Changelog Details**: See changelog files:
- `changelogs/0047-2025-11-12-package-version-display.md` for package version display
- `changelogs/0048-2025-11-12-orphaned-media-access-control-fix.md` for orphaned media access control fix

**Previous Release**: See [v0.6.0 Release Notes](./0.6.0-2025-11-12.md) for all features from v0.6.0 (note: v0.6.0 should not be installed due to migration bug).


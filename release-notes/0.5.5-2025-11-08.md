# Release Notes - Paideia LMS v0.5.5

**Release Date:** November 8, 2025  
**Version:** 0.5.5  
**Type**: Bug Fix / Enhancement / Refactoring  
**Impact**: High - Fixes job logging errors, achieves zero downtime during sandbox resets, and improves code organization  
**Changelog**: 0036, 0037

## Overview

Paideia LMS v0.5.5 is a significant release that fixes critical issues with sandbox reset functionality, achieving zero downtime during database resets. This release also includes important refactoring improvements that enhance code organization and maintainability. The sandbox reset now preserves system tables (job logs, migrations, etc.) while only clearing user data, eliminating errors and downtime that occurred when dropping the entire database.

---

## Features Added

### ðŸ”„ Zero Downtime Sandbox Reset

**Problem**: The sandbox reset used `migrateFresh` which dropped the entire database, causing:
- Job logging failures after reset
- Loss of system data (migration history, job logs, etc.)
- Downtime during reset (database dropped and recreated)
- Foreign key constraint violations

**Solution**: Refactored sandbox reset to selectively delete user data while preserving all system tables.

**Features**:
- **Zero downtime**: System tables remain intact, allowing the application to continue operating during reset
- **System data preservation**: Job logs, migration history, and other system tables are preserved
- **Transaction-safe**: All deletions wrapped in a single transaction (all-or-nothing)
- **Proper deletion order**: Deletes collections in correct order to respect foreign key constraints

**Technical Details**:
- Created `deleteAllUserData()` function that deletes 23 user data collections in order
- Preserves system tables: `payload-jobs`, `payload-jobs-log`, `payload-migrations`, `payload-kv`, `payload-locked-documents`, `payload-preferences`
- All deletions happen within a transaction for atomicity
- Application can continue serving requests during the reset process

**Benefits**:
- âœ… **Zero downtime** during sandbox resets
- âœ… Job logging works correctly after reset
- âœ… Migration history is preserved
- âœ… System state is maintained
- âœ… No foreign key constraint violations
- âœ… Better debugging capabilities

**Before (with `migrateFresh`)**:
- âŒ Entire database dropped (downtime)
- âŒ Schema recreated from migrations (extended downtime)
- âŒ All tables locked during drop/recreate operations
- âŒ Application unavailable during reset
- âŒ Total downtime: seconds to minutes depending on database size

**After (with selective deletion)**:
- âœ… System tables preserved (no downtime)
- âœ… Only user data deleted (minimal impact)
- âœ… Application continues operating during reset
- âœ… Schema remains intact (no recreation needed)
- âœ… Total downtime: **zero**

**Example**:
```bash
# Sandbox reset now happens with zero downtime
# System tables remain accessible during the process
# Application continues serving requests
```

### ðŸ› ï¸ Sandbox Reset CLI Command

**Problem**: No way to manually trigger sandbox reset from the command line.

**Solution**: Added new CLI command for manual sandbox reset.

**Features**:
- **Manual reset**: `paideia sandbox reset` command for manual database resets
- **Clear messaging**: Provides clear success/error messages
- **Proper validation**: Only works when `SANDBOX_MODE` is enabled
- **Consistent behavior**: Uses the same zero-downtime reset logic

**Usage**:
```bash
# Reset sandbox database manually (only works when SANDBOX_MODE is enabled)
paideia sandbox reset
```

**Benefits**:
- âœ… Manual sandbox reset capability
- âœ… Useful for development and testing
- âœ… Consistent with other CLI commands
- âœ… Clear error messages

### ðŸ“ CLI Commands Refactoring

**Problem**: All CLI commands were defined in `server/index.ts`, making the file large and hard to maintain.

**Solution**: Moved all CLI commands to a dedicated module `server/cli/commands.ts`.

**Features**:
- **Better organization**: CLI commands now in dedicated module
- **Centralized configuration**: `configureCommands()` function returns configured program
- **Reusable help**: `displayHelp()` function exported for reuse
- **Easier maintenance**: Commands easier to find and modify

**Benefits**:
- âœ… Cleaner `server/index.ts` file (reduced from ~365 to ~226 lines)
- âœ… Better code organization
- âœ… Easier to add new CLI commands
- âœ… Commands are now in a dedicated module

### ðŸ”§ Cron Jobs Management Internal Function

**Problem**: Cron jobs loader logic was embedded in the route loader, making it hard to test and reuse.

**Solution**: Extracted cron jobs logic to `server/internal/cron-jobs-management.ts`.

**Features**:
- **Reusable function**: `tryGetCronJobs()` function following Result pattern
- **Type safety**: Exported `CronJobInfo` and `GetCronJobsResult` types
- **Separation of concerns**: Business logic separated from HTTP handling
- **Testable**: Can be tested independently

**Benefits**:
- âœ… Separation of concerns (business logic vs HTTP handling)
- âœ… Reusable function (can be used elsewhere)
- âœ… Testable independently
- âœ… Consistent with other internal functions
- âœ… Cleaner loader code

---

## Bug Fixes

### Job Logging After Sandbox Reset

**Problem**: After a sandbox reset, Payload tried to log the task result but failed because the parent job record was deleted when the database was dropped.

**Error**:
```
Failed query: insert into "payload_jobs_log" ...
Key (_parent_id)=(1) is not present in table "payload_jobs"
```

**Root Cause**: `migrateFresh` dropped the entire database, including the `payload_jobs` table.

**Solution**: Changed to selective deletion that preserves system tables, allowing job logging to work correctly.

**Benefits**:
- âœ… Job logging works correctly after sandbox reset
- âœ… No more foreign key constraint violations
- âœ… Task execution status is properly recorded
- âœ… Job history is preserved

### Loss of System Data During Sandbox Reset

**Problem**: All system tables were deleted during sandbox reset, including:
- Job execution logs
- Migration history
- Key-value storage
- Locked documents
- User preferences

**Solution**: Selective deletion preserves all system tables while only clearing user data.

**Benefits**:
- âœ… Migration history is preserved
- âœ… Job logs are maintained
- âœ… System state is maintained
- âœ… Better debugging capabilities

---

## Migration Guide

### No Migration Required

This update is **backward compatible**. Existing installations will continue to work:

- âœ… Sandbox mode continues to work as before
- âœ… Seed data loading unchanged
- âœ… Daily reset cron job unchanged
- âœ… All CLI commands work exactly as before
- âœ… Admin cron jobs page works exactly as before
- âœ… No configuration changes needed

### Behavior Changes

**Sandbox Reset Behavior**:

**Before**:
- Sandbox reset dropped entire database
- System tables were deleted
- Job logging failed after reset
- Migration history was lost
- **Downtime during reset** (database dropped and recreated)

**After**:
- Sandbox reset only deletes user data
- System tables are preserved
- Job logging works correctly
- Migration history is preserved
- **Zero downtime during reset** (system tables remain intact)

### New CLI Command

**Sandbox Reset Command**:
```bash
# Reset sandbox database manually
paideia sandbox reset
```

**Note**: This command only works when `SANDBOX_MODE` is enabled. If sandbox mode is disabled, the command will exit silently (as designed by `tryResetSandbox`).

---

## Breaking Changes

None. All changes are backward compatible.

---

## Dependencies

No new dependencies added in this release.

---

## Testing

- âœ… Sandbox reset deletes all user data
- âœ… System tables are preserved
- âœ… Job logging works after reset
- âœ… No foreign key constraint violations
- âœ… Transaction rollback works on errors
- âœ… Seed data loads correctly after reset
- âœ… Daily cron job works correctly
- âœ… No errors in console after reset
- âœ… All existing CLI commands work correctly
- âœ… Sandbox reset command works when `SANDBOX_MODE` is enabled
- âœ… Admin cron jobs page displays correctly
- âœ… Error handling works properly
- âœ… Help command shows all commands including sandbox reset

---

## Technical Details

### Selective Data Deletion Strategy

**How It Works**:
1. **Transaction start**: Begin a database transaction
2. **Ordered deletion**: Delete collections in order from child to parent:
   - Submissions (assignment, quiz, discussion)
   - User grades, gradebook items, categories, gradebooks
   - Course grade tables, activity module links, grants
   - Enrollments, groups, course sections
   - Pages, whiteboards, notes
   - Activity modules, assignments, quizzes, discussions
   - Media, courses, course categories
   - Category role assignments
   - Users (last)
3. **Transaction commit**: Commit all deletions atomically
4. **Rollback on error**: If any deletion fails, all changes are rolled back

**System Tables Preserved**:
- `payload_jobs` - Job execution records
- `payload_jobs_log` - Job execution logs
- `payload_migrations` - Migration history
- `payload_kv` - Key-value storage
- `payload_locked_documents` - Document locking records
- `payload_preferences` - User preferences

### Zero Downtime Architecture

**How Zero Downtime Works**:
- System tables remain intact and accessible during the reset process
- Application can continue operating normally while user data is being cleared
- No schema recreation required (migrations are preserved)
- No table dropping/recreation overhead
- Deletions happen within a transaction (atomic operation)
- Application can continue serving requests during the reset process
- No schema locks or table drops that would cause downtime

### CLI Commands Structure

**Before**:
```typescript
// All commands in server/index.ts (~365 lines)
const program = new Command();
program.command("help")...
program.command("server")...
const migrateCommand = program.command("migrate")...
// ... many more commands
```

**After**:
```typescript
// server/cli/commands.ts (dedicated module)
export function configureCommands(payload: Payload): Command {
  const program = new Command();
  // ... all command definitions
  return program;
}

// server/index.ts (~226 lines, cleaner)
const program = configureCommands(payload);
program.command("server")... // Only server-specific commands
```

### Cron Jobs Management

**Before**:
```typescript
// app/routes/admin/cron-jobs.tsx
export const loader = async ({ context }) => {
  // ... authentication/authorization
  // ... 100+ lines of cron job mapping logic
  return { cronJobs, cronEnabled };
};
```

**After**:
```typescript
// server/internal/cron-jobs-management.ts
export const tryGetCronJobs = Result.wrap(
  async (payload: Payload): Promise<GetCronJobsResult> => {
    // ... cron job mapping logic
  }
);

// app/routes/admin/cron-jobs.tsx
export const loader = async ({ context }) => {
  // ... authentication/authorization
  const cronJobsResult = await tryGetCronJobs(payload);
  if (!cronJobsResult.ok) {
    throw new InternalServerErrorResponse(...);
  }
  return cronJobsResult.value;
};
```

---

## Thank You

Thank you for using Paideia LMS. This release fixes critical issues with sandbox reset functionality, achieving zero downtime during database resets. The refactoring improvements enhance code organization and maintainability, making it easier to add new features and maintain the codebase.

For questions, issues, or contributions, please visit our GitHub repository: https://github.com/paideia-lms/paideia

---

## Complete Changelog Reference

This release includes all changes from changelogs 0036 and 0037:

### Sandbox Reset Improvements (0036)
- **0036** - Zero Downtime Sandbox Reset: Preserves system tables during reset, achieving zero downtime
- **0036** - Selective Data Deletion: Deletes user data while preserving system tables
- **0036** - Job Logging Fix: Fixes job logging errors after sandbox reset

### Code Organization Improvements (0037)
- **0037** - CLI Commands Refactoring: Moved CLI commands to dedicated module
- **0037** - Sandbox Reset CLI Command: Added manual sandbox reset command
- **0037** - Cron Jobs Management: Extracted cron jobs logic to internal function

### Detailed Changelog

#### Zero Downtime Sandbox Reset
- Replaced `migrateFresh` with selective deletion
- Created `deleteAllUserData()` function
- Preserves system tables: `payload-jobs`, `payload-jobs-log`, `payload-migrations`, etc.
- Deletes 23 user data collections in correct order
- Transaction-safe (all-or-nothing operation)
- Zero downtime during reset process

#### Sandbox Reset CLI Command
- Added `paideia sandbox reset` command
- Manual database reset capability
- Only works when `SANDBOX_MODE` is enabled
- Clear success/error messages

#### CLI Commands Refactoring
- Created `server/cli/commands.ts` module
- Moved all CLI commands from `server/index.ts`
- Reduced `server/index.ts` from ~365 to ~226 lines
- Better code organization and maintainability

#### Cron Jobs Management
- Created `server/internal/cron-jobs-management.ts`
- Extracted `tryGetCronJobs()` function
- Exported `CronJobInfo` and `GetCronJobsResult` types
- Improved separation of concerns

---

**Full Changelog Details**: See changelog files:
- `changelogs/0036-2025-11-08-sandbox-reset-preserve-system-tables.md` for detailed information about sandbox reset improvements
- `changelogs/0037-2025-11-08-cli-refactoring-and-cron-jobs-management.md` for detailed information about code organization improvements

